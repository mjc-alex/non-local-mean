# non-local mean 算法
## 算法原理
均值滤波的核心思路是取每一个像素点邻域的矩形窗口，计算矩形窗口内所有像素点的像素平均值，作为该点滤波之后的像素值。高斯滤波与均值滤波类似，都是计算矩形窗口内所有像素点的像素值加权和，只不过其权重与均值滤波不一样，高斯滤波的权重服从二维正态分布，越靠近窗口中心点（也即当前滤波点），权重越大。**非局部均值滤波则使用当前滤波点的邻域块与矩形窗口内其它点的邻域块的相似度来计算权重，相似度越大则权重越大**。
![](images/Pasted%20image%2020240222213833.png)
其中，MSE是最常用的相似度衡量指标之一，假设均为m行n列，那么MSE的计算如下式，其中A(i,j)为点A邻域块中的点(i,j)的像素值，B(i,j)为点B邻域块中的相同位置点的像素值
$$MSE(A,B) = \frac{1}{mn}\sum_{i=0}^{m-1}\sum_{j=0}^{n-1}(A(i,j)-B(i,j))^2$$
由以上可知，非局部均值滤波算法有两个重要的参数：ksize和ssize。假设点A为当前待滤波点，邻域块分别取以点A和点B为中心的ksize * ksize区域，矩形窗口（也称为搜索窗口）取以点A为中心ssize * ssize大小。由于ksize和ssize都是奇数，通常传入它们的半值：half_ksize和half_ssize。所以，邻域块的大小为(2*half_ksize+1)*(2*half_ksize+1)，搜索窗口的大小为(2*half_ssize+1)*(2*half_ssize+1)。如下图所示：
![](images/Pasted%20image%2020240222214157.png)
点A的滤波值由搜索窗口内所有点的像素值加权平均得到：
$$ NLmeans(A) = \sum w(A,B)*I(B)$$
上式中，w(A,B)为点A与搜索窗口中任意一点B的高斯权重，由两点各自邻域块的MSE相似度计算而得。如下式，w(A,B)需要除以搜索窗口内所有点的高斯系数之和，以实现归一化的目的。**其中h也是一个重要的参数，h越大去噪效果越好，但是图像越模糊，反之h越小去噪效果越差，但去噪之后的失真度越小**。
$$w(A,B)=\frac{1}{sum}e^{-\frac{MSE(A,B)}{h^2}}$$
$$sum = \sum e^{-\frac{MSE(A,B)}{h^2}}$$
由于原图像中每一个待滤波的点都需要取完整的一个搜索窗口和多个邻域块，因此非局部均值滤波之前，首先要对图像进行边缘扩充，上、下、左、右分别扩充half_ssize+half_ksize的行、行、列、列：
![](images/Pasted%20image%2020240222215353.png)

